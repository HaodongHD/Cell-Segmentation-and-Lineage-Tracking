# Cell Segmentation and Lineage Tracking

This repository provides a modular MATLAB pipeline for **cell segmentation** and **cell lineage tracking** based on probability maps generated by [ilastik](https://www.ilastik.org/). The pipeline is optimized for time-lapse microscopy of thousands of cells and supports accurate centroid extraction, region-of-interest filtering, and frame-to-frame lineage tracking.

## ðŸ“¦ Overview

The workflow consists of two main stages:

1. **Segmentation** â€“ Converts ilastik probability maps into clean binary and labeled masks, extracts cell centroids, and optionally saves overlay images.
2. **Tracking** â€“ Links centroids across time points to build lineage maps and optionally visualizes trajectories over the raw image stack.

Both stages are written as standalone MATLAB functions:

* [`segment_cells_from_ilastik.m`](segment_cells_from_ilastik.m)
* [`track_cell_lineages.m`](track_cell_lineages.m)

---

## ðŸ§© Requirements

* MATLAB R2021a or newer
* Toolboxes:

  * Image Processing Toolbox
  * (Optional) Parallel Computing Toolbox for faster processing
  * (Optional) Statistics and Machine Learning Toolbox (`matchpairs`) for optimal assignment

---

## ðŸ§  Stage 1 â€” Cell Segmentation

```matlab
opts = struct( ...
  'pix2micron', 0.69, ...                 % Âµm per pixel
  'roiCenter_um', [0 0], ...              % center of region of interest
  'roiRadius_um', 5000, ...               % ROI radius; Inf = disable
  'isProbability', true, ...              % ilastik output type
  'probThreshold', [], ...                % [] => Otsu per frame
  'doWatershed', true, ...                % split touching cells
  'plotOverlays', true, ...
  'overlayDir', 'segmentation_overlays', ...
  'plotSummaries', true, ...
  'saveMat', true, ...
  'matOutPath', 'segmentation_results.mat' ...
);

R_seg = segment_cells_from_ilastik('somite_july_short_binary.h5', ...
                                   '/exported_data', ...
                                   'Somite_July_short_green.tif', ...
                                   opts);
```

### Outputs

* `R_seg.labels_TYX` â€” 3D label arrays (time Ã— height Ã— width)
* `R_seg.centroids_um` â€” per-frame cell centroids in Âµm
* `R_seg.count_total`, `R_seg.count_roi` â€” cell counts over time
* Optional: TIFF overlays + CSV summary

---

## ðŸ”— Stage 2 â€” Cell Lineage Tracking

```matlab
load segmentation_results.mat   % contains r_c or centroids
opts = struct( ...
  'positionsAreMicrons', true, ...
  'pix2micron', 0.69, ...
  'matchingMode', 'many2one', ...      % or 'one2one'
  'maxLinkDistance_um', Inf, ...
  'plotOverlays', true, ...
  'overlayDir', 'tracking_result', ...
  'overlayMarkerSz', 6, ...
  'saveMat', true, ...
  'matOutPath', 'tracking_lineage.mat' ...
);

R_track = track_cell_lineages(R_seg.centroids_roi_um, ...
                              'Somite_July_short_green.tif', ...
                              opts);
```

### Outputs

* `R_track.cell_lineage_index` â€” lineage table (lineage Ã— time)
* `R_track.index_adjacent_time` â€” parent-child mapping arrays
* `R_track.colors_rgb` â€” unique lineage colors
* Optional: overlay images showing consistent lineage colors

---

## âš™ï¸ Design Features

* Modular and reproducible: fully parameterized functions.
* Supports both 2D and time-series (3D) image stacks.
* Robust morphological cleanup and area filtering.
* Optional Gaussian smoothing and watershed separation.
* Parallelized processing (`parfor`) for large time-lapse datasets.
* Automatically saves all configuration parameters in results.

---

## ðŸ“Š Example Output

| Step         | Description                        | Output                                         |
| ------------ | ---------------------------------- | ---------------------------------------------- |
| Segmentation | Binary and labeled masks per frame | ![segmentation](docs/example_segmentation.png) |
| Tracking     | Colored cell trajectories          | ![tracking](docs/example_tracking.png)         |

---

## ðŸ§ª Testing with Synthetic Data

To test the pipeline without biological data, use synthetic Gaussian blob movies:

```matlab
[Y, X, T] = deal(128, 128, 10);
[Xg, Yg] = meshgrid(1:X, 1:Y);
mov = zeros(Y, X, T);
for t = 1:T
    cx = 30 + 5*t; cy = 64; sigma = 5;
    mov(:,:,t) = exp(-((Xg-cx).^2 + (Yg-cy).^2)/(2*sigma^2));
end
imwrite(uint8(255*mov(:,:,1)/max(mov(:))), 'synthetic.tif');
```

Then segment and track using the same functions.

---

## ðŸ§¾ Citation

If you use this code for research or publication, please cite:

> Qin, H. (2025). *Physics-informed geometric modeling of biological aging and information flow in cell populations.* Salk Institute for Biological Studies.

---

## ðŸ“¬ Contact

For questions or collaborations, please contact **Haodong Qin** at [haodongqin@ucsd.edu](mailto:haodongqin@ucsd.edu).
