# Cell Segmentation and Lineage Tracking

This repository provides a modular MATLAB pipeline for **cell segmentation** and **cell lineage tracking** based on probability maps generated by [ilastik](https://www.ilastik.org/). The pipeline is optimized for time-lapse microscopy of thousands of cells and supports accurate centroid extraction, region-of-interest filtering, and frame-to-frame lineage tracking.

## üì¶ Overview

The workflow consists of two main stages:

1. **Segmentation** ‚Äì Converts ilastik probability maps into clean binary and labeled masks, extracts cell centroids, and optionally saves overlay images.
2. **Tracking** ‚Äì Links centroids across time points to build lineage maps and optionally visualizes trajectories over the raw image stack.

Both stages are written as standalone MATLAB functions:

* [`segment_cells_from_ilastik.m`](segment_cells_from_ilastik.m)
* [`track_cell_lineages.m`](track_cell_lineages.m)

---

## üß© Requirements

* MATLAB R2021a or newer
* Toolboxes:

  * Image Processing Toolbox
  * (Optional) Parallel Computing Toolbox for faster processing
  * (Optional) Statistics and Machine Learning Toolbox (`matchpairs`) for optimal assignment

---

## üß† Stage 1 ‚Äî Cell Segmentation

```matlab
opts = struct( ...
  'pix2micron', 0.69, ...                 % ¬µm per pixel
  'roiCenter_um', [0 0], ...              % center of region of interest
  'roiRadius_um', 5000, ...               % ROI radius; Inf = disable
  'isProbability', true, ...              % ilastik output type
  'probThreshold', [], ...                % [] => Otsu per frame
  'doWatershed', true, ...                % split touching cells
  'plotOverlays', true, ...
  'overlayDir', 'segmentation_overlays', ...
  'plotSummaries', true, ...
  'saveMat', true, ...
  'matOutPath', 'segmentation_results.mat' ...
);

R_seg = segment_cells_from_ilastik('somite_july_short_binary.h5', ...
                                   '/exported_data', ...
                                   'Somite_July_short_green.tif', ...
                                   opts);
```

### Outputs

* `R_seg.labels_TYX` ‚Äî 3D label arrays (time √ó height √ó width)
* `R_seg.centroids_um` ‚Äî per-frame cell centroids in ¬µm
* `R_seg.count_total`, `R_seg.count_roi` ‚Äî cell counts over time
* Optional: TIFF overlays + CSV summary

---

## üß¨ Example Segmentation Result

The figure below shows an example of cell segmentation output produced by the pipeline:

![Cell segmentation example](docs/cell_segmentation_example.png)

## üîó Stage 2 ‚Äî Cell Lineage Tracking

```matlab
load segmentation_results.mat   % contains r_c or centroids
opts = struct( ...
  'positionsAreMicrons', true, ...
  'pix2micron', 0.69, ...
  'matchingMode', 'many2one', ...      % or 'one2one'
  'maxLinkDistance_um', Inf, ...
  'plotOverlays', true, ...
  'overlayDir', 'tracking_result', ...
  'overlayMarkerSz', 6, ...
  'saveMat', true, ...
  'matOutPath', 'tracking_lineage.mat' ...
);

R_track = track_cell_lineages(R_seg.centroids_roi_um, ...
                              'Somite_July_short_green.tif', ...
                              opts);
```

### Outputs

* `R_track.cell_lineage_index` ‚Äî lineage table (lineage √ó time)
* `R_track.index_adjacent_time` ‚Äî parent-child mapping arrays
* `R_track.colors_rgb` ‚Äî unique lineage colors
* Optional: overlay images showing consistent lineage colors

---

## ‚öôÔ∏è Design Features

* Modular and reproducible: fully parameterized functions.
* Supports both 2D and time-series (3D) image stacks.
* Robust morphological cleanup and area filtering.
* Optional Gaussian smoothing and watershed separation.
* Parallelized processing (`parfor`) for large time-lapse datasets.
* Automatically saves all configuration parameters in results.

---




## üßæ Citation
If you use this code for research or publication, please cite:
Cislo, D.J., Yang, F., Qin, H. et al. Active cell divisions generate fourfold orientationally ordered phase in living tissue. Nature Physics 19, 1201‚Äì1210 (2023). https://doi.org/10.1038/s41567-023-02025-3

---


